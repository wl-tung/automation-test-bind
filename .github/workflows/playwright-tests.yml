name: ğŸš€ BiNDup Automation Tests - Chrome & WebKit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM JST (17:00 UTC)
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - site-creation
          - image-crud
          - site-theater
      browsers:
        description: 'Browsers to test'
        required: false
        default: 'chromium,webkit'
        type: choice
        options:
          - chromium,webkit
          - chromium
          - webkit

jobs:
  test:
    name: ğŸ§ª Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, webkit]
        
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'tests/playwright-tests/package-lock.json'
        
    - name: ğŸ“¦ Install dependencies
      working-directory: tests/playwright-tests
      run: |
        npm ci
        
    - name: ğŸ­ Install Playwright browsers
      working-directory: tests/playwright-tests
      run: |
        npx playwright install ${{ matrix.browser }} --with-deps
        
    - name: ğŸ§ª Run Playwright tests
      working-directory: tests/playwright-tests
      run: |
        npx playwright test --project=${{ matrix.browser }} --workers=2 --max-failures=10 --reporter=html,json,junit
      env:
        CI: true
        
    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-results-${{ matrix.browser }}
        path: |
          tests/playwright-tests/test-results/
          tests/playwright-tests/playwright-report/
        retention-days: 7
        
    - name: ğŸ“ˆ Upload test report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.browser }}
        path: tests/playwright-tests/playwright-report/
        retention-days: 7

  report:
    name: ğŸ“Š Generate Combined Report
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“Š Generate combined report
      run: |
        echo "# ğŸš€ BiNDup Automation Test Results" > test-summary.md
        echo "" >> test-summary.md
        echo "## ğŸ“Š Test Execution Summary" >> test-summary.md
        echo "" >> test-summary.md
        
        # Check if test results exist
        if [ -d "artifacts/playwright-results-chromium" ]; then
          echo "âœ… **Chromium Tests**: Executed" >> test-summary.md
        else
          echo "âŒ **Chromium Tests**: Failed or not executed" >> test-summary.md
        fi
        
        if [ -d "artifacts/playwright-results-webkit" ]; then
          echo "âœ… **WebKit Tests**: Executed" >> test-summary.md
        else
          echo "âŒ **WebKit Tests**: Failed or not executed" >> test-summary.md
        fi
        
        echo "" >> test-summary.md
        echo "## ğŸ”— Artifacts" >> test-summary.md
        echo "" >> test-summary.md
        echo "- ğŸ“Š Test Reports: Available in artifacts" >> test-summary.md
        echo "- ğŸ¥ Videos: Available for failed tests" >> test-summary.md
        echo "- ğŸ“¸ Screenshots: Available for failed tests" >> test-summary.md
        echo "- ğŸ” Traces: Available for debugging" >> test-summary.md
        
        cat test-summary.md
        
    - name: ğŸ“Š Upload combined report
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: test-summary.md
        retention-days: 30
